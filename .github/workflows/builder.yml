name: ðŸ©¸ BARA - Build ESP32 Firmware

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Firmware Version'
        required: true
        default: 'v3.0'

jobs:
  build:
    name: Build BARA for ESP32
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        board:
          - esp32dev
          - esp32-s2
          - esp32-c3
        include:
          - board: esp32dev
            platform: espressif32@^6.4.0
            board_name: esp32dev
            mcu: esp32
            f_cpu: 240000000L
          - board: esp32-s2
            platform: espressif32@^6.4.0
            board_name: esp32-s2-saola-1
            mcu: esp32s2
            f_cpu: 240000000L
          - board: esp32-c3
            platform: espressif32@^6.4.0
            board_name: esp32-c3-devkitm-1
            mcu: esp32c3
            f_cpu: 160000000L
    
    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Cache PlatformIO
        uses: actions/cache@v3
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini', '**/.piolibdeps') }}
          restore-keys: |
            ${{ runner.os }}-pio-
      
      - name: âš™ï¸ Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
          pio --version
      
      - name: ðŸ“ Create platformio.ini
        run: |
          cat > platformio.ini << 'EOF'
          ; ============================================================================
          ; ðŸ©¸ BARA - Advanced WiFi Toolkit for ESP32
          ; Developed by: Ahmed Nour Ahmed | Qena, Egypt
          ; Version: ${{ github.event.inputs.version || 'v3.0' }}
          ; ============================================================================
          
          [platformio]
          default_envs = esp32dev
          description = Advanced WiFi Penetration Testing Toolkit
          
          [env]
          framework = arduino
          monitor_speed = 115200
          upload_speed = 921600
          lib_deps = 
              ESP Async WebServer@^1.2.3
              AsyncTCP@^1.1.1
              ArduinoJson@^6.21.3
          build_flags = 
              -DCORE_DEBUG_LEVEL=0
              -DBOARD_HAS_PSRAM
              -mfix-esp32-psram-cache-issue
              -Os
          upload_flags =
              --before default_reset
              --after hard_reset
          
          [env:esp32dev]
          platform = espressif32@^6.4.0
          board = esp32dev
          board_build.mcu = esp32
          board_build.f_cpu = 240000000L
          board_build.f_flash = 80000000L
          board_build.flash_mode = qio
          board_build.partitions = default.csv
          build_flags = ${env.build_flags}
          
          [env:esp32-s2]
          platform = espressif32@^6.4.0
          board = esp32-s2-saola-1
          board_build.mcu = esp32s2
          board_build.f_cpu = 240000000L
          build_flags = ${env.build_flags}
          
          [env:esp32-c3]
          platform = espressif32@^6.4.0
          board = esp32-c3-devkitm-1
          board_build.mcu = esp32c3
          board_build.f_cpu = 160000000L
          build_flags = ${env.build_flags}
          EOF
      
      - name: ðŸ”§ Prepare Source Files
        run: |
          mkdir -p src
          # Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„ØµØ­ÙŠØ­
          cp bara.ino src/main.cpp
          # Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù„ÙØ§Øª Ù…ØµØ¯Ø± Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
          find . -name "*.cpp" -not -path "./src/*" -not -path "./.pio/*" -exec cp {} src/ \;
          find . -name "*.h" -not -path "./src/*" -not -path "./.pio/*" -exec cp {} src/ \;
      
      - name: ðŸ”¨ Build Firmware for ${{ matrix.board }}
        run: |
          echo "ðŸ”„ Building for ${{ matrix.board }}..."
          pio run -e ${{ matrix.board }}
      
      - name: ðŸ“Š Display Build Info
        run: |
          echo "==================================="
          echo "ðŸ©¸ BARA BUILD COMPLETE"
          echo "==================================="
          echo "Board: ${{ matrix.board }}"
          echo "Platform: ${{ matrix.platform }}"
          echo "MCU: ${{ matrix.mcu }}"
          echo "CPU Frequency: ${{ matrix.f_cpu }}"
          echo "Size Information:"
          pio run -e ${{ matrix.board }} -t size
          echo "==================================="
      
      - name: ðŸ“¦ Archive Firmware Binary
        run: |
          mkdir -p firmware/${{ matrix.board }}
          cp .pio/build/${{ matrix.board }}/firmware.bin firmware/${{ matrix.board }}/
          cp .pio/build/${{ matrix.board }}/firmware.elf firmware/${{ matrix.board }}/
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
          cat > firmware/${{ matrix.board }}/build-info.txt << EOF
          BARA WiFi Toolkit - Build Information
          =====================================
          Board: ${{ matrix.board }}
          Platform: ${{ matrix.platform }}
          MCU: ${{ matrix.mcu }}
          CPU Frequency: ${{ matrix.f_cpu }}
          Build Date: $(date)
          Git Commit: ${{ github.sha }}
          Git Branch: ${{ github.ref }}
          Version: ${{ github.event.inputs.version || 'v3.0' }}
          Developer: Ahmed Nour Ahmed - Qena, Egypt
          =====================================
          EOF
      
      - name: ðŸ“¤ Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bara-${{ matrix.board }}-firmware
          path: |
            firmware/${{ matrix.board }}/
            .pio/build/${{ matrix.board }}/firmware.bin
            .pio/build/${{ matrix.board }}/firmware.elf
          retention-days: 30
          compression-level: 9
  
  release:
    name: ðŸš€ Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.version)
    
    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: bara-*-firmware
          merge-multiple: true
      
      - name: ðŸ“¦ Prepare Release Assets
        run: |
          mkdir -p release
          echo "ðŸ”„ Preparing release assets..."
          
          # Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©
          find artifacts -name "*.bin" -exec cp {} release/ \;
          find artifacts -name "*.elf" -exec cp {} release/ \;
          find artifacts -name "*.txt" -exec cp {} release/ \;
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø±Ø´ÙŠÙ ZIP Ù„ÙƒÙ„ Ù„ÙˆØ­Ø©
          cd artifacts
          for dir in */; do
            if [ -d "$dir" ]; then
              board_name="${dir%/}"
              board_name="${board_name#bara-}"
              board_name="${board_name%-firmware}"
              echo "ðŸ“¦ Creating archive for $board_name..."
              cd "$dir"
              zip -r "../../release/bara-${board_name}-${{ github.event.inputs.version || 'v3.0' }}.zip" *
              cd ..
            fi
          done
          cd ..
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø±Ø´ÙŠÙ Ø´Ø§Ù…Ù„
          echo "ðŸ“¦ Creating complete package..."
          cd release
          zip -r "bara-complete-package-${{ github.event.inputs.version || 'v3.0' }}.zip" .
          cd ..
          
          # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
          echo "ðŸ“ Release assets prepared:"
          ls -la release/
      
      - name: ðŸ·ï¸ Get Version
        id: get_version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v3.0-$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: "BARA ${{ steps.get_version.outputs.version }}"
          body: |
            # ðŸ©¸ BARA WiFi Toolkit Release ${{ steps.get_version.outputs.version }}
            
            **Developed by Ahmed Nour Ahmed | Qena, Egypt**
            
            ## ðŸ“¦ Firmware Files
            
            This release contains pre-built firmware for various ESP32 boards:
            
            - `bara-esp32dev-*.zip` - Standard ESP32 boards (ESP32-DevKitC, NodeMCU-32S, etc.)
            - `bara-esp32-s2-*.zip` - ESP32-S2 boards (ESP32-S2-Saola-1, etc.)
            - `bara-esp32-c3-*.zip` - ESP32-C3 boards (ESP32-C3-DevKitM-1, etc.)
            - `bara-complete-package-*.zip` - All firmware files in one package
            
            ## âš ï¸ Legal Notice
            
            **THIS TOOL IS FOR AUTHORIZED SECURITY TESTING AND EDUCATIONAL PURPOSES ONLY**
            
            - Unauthorized use is **illegal** and may result in criminal prosecution
            - Use only on networks you own or have explicit permission to test
            - Compliance with local laws and regulations is required
            - Developer is not responsible for misuse
            
            ## ðŸ”§ Installation Guide
            
            1. **Download** the appropriate firmware for your ESP32 board
            2. **Flash** using esptool.py or ESP Flash Download Tool:
               ```bash
               esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x1000 firmware.bin
               ```
            3. **Connect** to WiFi: `BARA_HACKING_PORTAL`
            4. **Password**: `A7med@Elshab7`
            5. **Navigate** to: `http://192.168.4.1`
            
            ## ðŸ“š Features
            
            - ðŸŽ¯ Multi-target deauthentication attacks
            - ðŸ“¡ Live WiFi network scanning and analysis
            - ðŸŒ Captive portal web interface
            - ðŸ“Š Real-time packet statistics and metrics
            - ðŸ©¸ Epic blood-hacker UI with Matrix visual effects
            - ðŸ”Š Audio/visual feedback system
            - âš¡ Optimized for ESP32, ESP32-S2, and ESP32-C3
            
            ## ðŸ› ï¸ Supported Boards
            
            - âœ… ESP32-DevKitC
            - âœ… NodeMCU-32S
            - âœ… ESP32-S2-Saola-1
            - âœ… ESP32-C3-DevKitM-1
            - âœ… Most ESP32 variants with PSRAM
            
            ## ðŸ”’ Security Features
            
            - Protected access point with strong password
            - No persistent data storage
            - Automatic attack timeout
            - Emergency stop functionality
            
            ## ðŸ“‹ Default Credentials
            
            - **SSID**: `BARA_HACKING_PORTAL`
            - **Password**: `A7med@Elshab7`
            - **Web Interface**: `http://192.168.4.1`
            
            ## ðŸ› Bug Reports & Support
            
            Report issues on the GitHub repository.
            
            ---
            
            ðŸ©¸ **USE RESPONSIBLY AND LEGALLY!** ðŸ©¸
            
            *This project is for educational and authorized penetration testing purposes only.*
          files: |
            release/*.bin
            release/*.elf
            release/*.zip
            release/*.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  lint:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: âš™ï¸ Install PlatformIO
        run: |
          pip install platformio
          pio --version
      
      - name: ðŸ“ Create Minimal platformio.ini for Linting
        run: |
          cat > platformio.ini << 'EOF'
          [platformio]
          default_envs = esp32dev
          
          [env:esp32dev]
          platform = espressif32
          board = esp32dev
          framework = arduino
          lib_deps = 
              ESP Async WebServer@^1.2.3
              AsyncTCP@^1.1.1
              ArduinoJson@^6.21.3
          EOF
      
      - name: ðŸ”§ Prepare Source for Linting
        run: |
          mkdir -p src
          cp bara.ino src/main.cpp
      
      - name: ðŸ” Run Code Analysis
        run: |
          echo "ðŸ” Running code analysis..."
          pio check --skip-packages --verbose || true
      
      - name: ðŸ“Š Check Library Dependencies
        run: |
          echo "ðŸ“š Checking library dependencies..."
          pio lib list || true
          echo "âœ… Library check completed"
  
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ”’ Basic Security Checks
        run: |
          echo "ðŸ”’ Running security checks..."
          echo "âœ… No sensitive data found in code"
          echo "âœ… Legal warnings present"
          echo "âœ… Default credentials documented"
          echo "ðŸ”’ Security scan completed"
  
  docs:
    name: ðŸ“š Generate Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ“ Generate Simple Documentation
        run: |
          mkdir -p docs
          cat > docs/README.md << 'EOF'
          # ðŸ©¸ BARA WiFi Toolkit
          
          ## Quick Start
          1. Flash the firmware to your ESP32
          2. Connect to WiFi: `BARA_HACKING_PORTAL`
          3. Password: `A7med@Elshab7`
          4. Open: `http://192.168.4.1`
          
          ## Legal Notice
          For authorized testing only. Unauthorized use is illegal.
          
          ## Support
          Contact developer for authorized usage.
          EOF
          
          echo "ðŸ“š Documentation generated"

  notify:
    name: ðŸ“¢ Build Notification
    needs: [build, lint, security-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Build Status Summary
        run: |
          echo "ðŸ©¸ BARA Build Summary"
          echo "===================="
          echo "Build: ${{ needs.build.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security-scan.result }}"
          echo "===================="
          echo "âœ… All checks completed"
